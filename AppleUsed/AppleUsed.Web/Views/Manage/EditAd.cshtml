@model AppleUsed.Web.Models.ViewModels.AdViewModels.AdViewModel
@using Newtonsoft.Json
@using ImageMagick

@{
    ViewData["Title"] = "Редактирование объявления";
}

<h4>@ViewData["Title"]</h4>

<hr />

@Html.ActionLink("Назад", "MageAdsByUser", "Manage", new { @class = "btn btn-default" })

<div class="row">
    <div class="col-md-8">
        <form asp-action="SaveAd" method="post" enctype="multipart/form-data">
            <div asp-validation-summary="ModelOnly" class="text-danger"></div>

            <blockquote style="border-left:5px solid #5cb85c">
                <p> Измените те части объявления, которые необходимы. </p>
            </blockquote>

            <div class="form-group">
                <label class="control-label">Заголовок : </label>
                <input asp-for="AdDTO.Title" class="form-control" />
                <span asp-validation-for="AdDTO.Title" class="text-danger"></span>
            </div>

            <div class="form-group">
                <label class="control-label">Стоимость : </label>
                <input asp-for="AdDTO.Price" class="form-control" />
                <span asp-validation-for="AdDTO.Price" class="text-danger"></span>
            </div>

            <div class="form-group">
                <label class="control-label">Выберите категорию : </label>
                <select asp-for="AdDTO.SelectedProductTypeId" asp-items="Model.ProductTypesSelectList" id="ProductType" class="form-control">
                    <option selected="selected" disabled="disabled">Выберите модель</option>
                </select>
            </div>

            <div class="form-group" id="ProductModel">
                <label class="control-label">Выберите модель : </label>
                <select asp-for="AdDTO.SelectedProductModelId" asp-items="Model.ProductModelsSelectList" id="ProductModelItems" class="form-control">
                    <option selected="selected" disabled="disabled"> </option>
                </select>
            </div>

            <div class="form-group">
                <label class="control-label">Память : </label>
                <select asp-for="AdDTO.SelectedProductMemoryId" asp-items="Model.ProductMemoriesSelectList" class="form-control">
                    <option selected="selected" disabled="disabled"> </option>
                </select>
            </div>

            <div class="form-group">
                <label class="control-label">Цвет : </label>
                <select asp-for="AdDTO.SelectedProductColorId" asp-items="Model.ProductColorsSelectList" class="form-control">
                    <option selected="selected" disabled="disabled"> </option>
                </select>
            </div>

            <div class="form-group">
                <label class="control-label">Состояние : </label>
                <select asp-for="AdDTO.SelectedProductStatesId" asp-items="Model.ProductStatesSelectList" class="form-control">
                    <option selected="selected" disabled="disabled"> </option>
                </select>
            </div>

            <div class="form-group">
                <label class="control-label">Описание товара : </label>
                @Html.TextAreaFor(m => m.AdDTO.Description, new { @class = "form-control", @row = 3 })
                <span asp-validation-for="AdDTO.Description" class="text-danger"></span>
            </div>

            <blockquote style="border-left:5px solid #5cb85c">
                <p>Фото товара : </p>
            </blockquote>




            <div class="form-group">
                <div id="photos-area">

                    @foreach (var item in Model.AdDTO.PhotosForEdit)
                    {


                        <div class="row">

                            @using (MagickImage image = new MagickImage(item.Photo))
                            {
                                var base64 = image.ToBase64();
                                var src = String.Format("data:image/jpg;base64,{0}", base64);

                                <div class="col-sm-6">
                                    <img style='max-width:170px; max-height:130px;' src="@src" />
                                </div>
                            }

                            <button class="btn btn-default">Заменить</button>
                            <a class="btn btn-danger" data-type="DeleteButton" value="@item.AdPhotosId">Удалить</a>


                        </div>

                        <br />

                    }
                    @if (Model.AdDTO.PhotosForEdit.Count() < 5)
                    {
                        <div id="loadImagesArea">
                            <input name="Photos" type="file" class="form-control" />
                        </div>
                    }

                </div>
            </div>



            <div class="form-group">
                <input type="submit" value="Подать" class="btn btn-success" />
            </div>

        </form>
    </div>
</div>

<div>
    <a asp-action="Index">Back to List</a>
</div>

<script type="text/javascript">

    $(document).ready(function () {


        let adId = parseInt('@ViewBag.AdId');

        if (adId > 0) {

            $(function () {
                $('#ProductModel').show();
            });
        }

    });


    $('#ProductType').on('change', function () {

        GetProductModelsByProductTypes(this.value);

    });

    function GetProductModelsByProductTypes(selectedProductType) {

        var data = GetDataForSendController(selectedProductType);

        $.ajax({
            type: "POST",
            url: "@Url.Action("GetProductModelsSelectList")",
            beforeSend: function (xhr) {
                xhr.setRequestHeader("XSRF-TOKEN",
                    $('input:hidden[name="__RequestVerificationToken"]').val());
            },
            data: data ,
            dataType: "json",
            contentType: "application/json; charset=utf-8",
            success: function (data) {

                var items = '';
                $('#ProductModelItems').empty();

                $.each(data, function (i, selectedModel) {
                    items += "<option value='" + selectedModel.value + "'>" + selectedModel.text + "</option>";
                });

                $('#ProductModelItems').html(items);

                console.log(items);

                $('#ProductModel').show();
                data.empty;
            },
            failure: function (errMsg) {
                alert(errMsg);
            }
        });
    }

    function GetDataForSendController(selectedValue) {

        var data = '@Html.Raw(Json.Serialize(Model.AdDTO))';
        var parseData = $.parseJSON(data);
        parseData.selectedProductType = selectedValue;
        data = JSON.stringify(parseData);

        return data;
    }



    function readSingleFile(e) {
        var file = e.target.files[0];
        if (!file) {
            return;
        }
        var reader = new FileReader();
        reader.onload = function (e) {
            var contents = e.target.result;
            displayContents(contents);
        };
        reader.readAsText(file);
    }

    function displayContents(contents) {
        var element = document.getElementById('file-content');
        element.textContent = contents;
    }



    $('#photos-area').on('click', '[data-type="DeleteButton"]', function () {

        var id = $(this).prop("value");
        var row = $(this).closest('div');

        $.ajax({
            url: "/Manage/DeletePhoto?photoId=" + id,
            type: "GET",
            success: function (data) {

                $("#ErrorMassage").text("");
                row.remove();

                $("#loadImagesArea").html('"<input name="Photos" type="file" class="form-control" />"');
            },
            error: function (data) {

                $("#ErrorMassage").text(data.statusText);
            }
        });
    });

 

    //$('#photos-area').on('click', '[data-type="DeleteButton"]', function () {

    //    var row = $(this).closest('div');

    //    if (confirm("Are you sure you want to delete this Photo?")) {

    //        var id = $(this).prop("value");

    //        id = this.value;

    //        $.ajax({
    //            url: "/Menage/DeletePhoto?photoId=" + id,
    //            type: "GET",
    //            success: function (data) {

    //                $("#ErrorMassage").text("");
    //                row.remove();

    //                $("#loadImagesArea").html('"<input name="Photos" type="file" class="form-control" />"');
    //            },
    //            error: function (data) {

    //                $("#ErrorMassage").text(data.statusText);
    //            }
    //        });
    //    }

    //});



</script>

@section Scripts {
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}
}
